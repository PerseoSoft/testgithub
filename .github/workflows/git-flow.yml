name: Git Flow PR Check

on:
  pull_request:
    branches:
      - master
      - develop
      - feature/*
      - hotfix/*
      - release/*

jobs:
  git-flow-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Install Git
      run: sudo apt-get install git -y

    - name: Check git flow
      run: |
        SOURCE_BRANCH=$(jq --raw-output .pull_request.head.ref "$GITHUB_EVENT_PATH")
        TARGET_BRANCH=$(jq --raw-output .pull_request.base.ref "$GITHUB_EVENT_PATH")

        echo $SOURCE_BRANCH
        echo $TARGET_BRANCH

        if ![ "$SOURCE_BRANCH" == feature*  || "$SOURCE_BRANCH" == hotfix*  ||  "$SOURCE_BRANCH" == release*  || "$SOURCE_BRANCH" == "master"  ||  "$SOURCE_BRANCH" == "develop" ]; then
          echo "Source branch not valid"
          exit 1
        fi

        if ![ "$TARGET_BRANCH" == feature*  || "$TARGET_BRANCH" == hotfix*  ||  "$TARGET_BRANCH" == release*  || "$TARGET_BRANCH" == "master"  ||  "$TARGET_BRANCH" == "develop" ]; then
          echo "Source branch not valid"
          exit 1
        fi

        if [[ "$SOURCE_BRANCH" == feature* && "$TARGET_BRANCH" != "develop" ]]; then
          echo "Source branch is 'feature' and target branch does not start with 'release'."
          exit 1
        fi

        if [[ "$SOURCE_BRANCH" == "develop" && "$TARGET_BRANCH" != release* ]]; then
          echo "Source branch is 'develop' and target branch does not start with 'release'."
          exit 1
        fi

        if [[ "$SOURCE_BRANCH" == hotfix* && "$TARGET_BRANCH" != "master" ]]; then
          echo "Source branch is 'hotfix' and target branch does not start with 'master'."
          exit 1
        fi

        if [[ "$SOURCE_BRANCH" == release* && "$TARGET_BRANCH" != "master" ]]; then
          echo "Source branch is 'release' and target branch does not start with 'master'."
          exit 1
        fi


        if [[ "$SOURCE_BRANCH" == "master" && "$TARGET_BRANCH" != "develop" ]]; then
          echo "Source branch is 'release' and target branch does not start with 'master'."
          exit 1
        fi


        echo "PR valid"

        exit 0
